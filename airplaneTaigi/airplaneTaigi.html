<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taigi Space Catch</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/addons/p5.sound.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; }
        canvas { display: block; }
        
        #replayButton, #nextButton, #pauseButton {
            position: absolute; 
            padding: 8px 16px; 
            font-size: 22px;
            background-image: url('/assets/taigi_space_catch/IMG_2992.PNG'); /* Set background image */
            background-size: cover; /* Scale image to cover button */
            background-position: center; /* Center the image */
            background-repeat: no-repeat; /* Prevent tiling */
            border: none; 
            cursor: pointer; 
            color: black;
            border-radius: 10px; /* Keep rounded corners */
        }
        
        #replayButton, #nextButton, #pauseButton {
            position: absolute; padding: 12px 20px; font-size: 24px;
            background-color: yellow; border: none; cursor: pointer; color: black;
        }
        #replayButton { top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; }
        #nextButton { top: 0px; left: 200px; }
        #pauseButton { top: 0px; left: 300px; }
    </style>
</head>
<body>
    <button id="replayButton" onclick="resetGame()">重 耍</button>
    <button id="nextButton" onclick="changeWord()">換 字</button>
    <button id="pauseButton" onclick="togglePause()">歇 睏</button>
<script>
    const ASSET_PATH = '/assets/taigi_space_catch/';
    const WARNING_INTERVAL = 10;
    const EFFECT_DURATION = 500;

    let starship, spaceObjects = [], effects = [], score = 0, lives = 5;
    let bgSpeed = 2, taigiWords = [], targetY, gameOver = false, isPaused = false;
    let objectSpawnCount = 0;
    let ignoreMouseMove = false;
    let clickSound, crashSound, bonusSound, gameOverSound, gameStartSound, laserSound;
    let spaceImg, starshipImg, starshipInDangerImg, spaceObject1Img, spaceObject2Img;
    let spaceObject3Img, spaceObject4Img, spaceObject5Img, spaceObject6Img, spaceObject7Img;
    let spaceObject8Img, spaceObject9Img, spaceObject10Img, scoreImg, livesImg;
    let bonusImg, explosionImg;
    let gameFont; // Declare variable for the new font
    
    let nextButton = document.getElementById('nextButton');
    let pauseButton = document.getElementById('pauseButton');
    let replayButton = document.getElementById('replayButton');

    function preload() {
        // Load the new font
        gameFont = loadFont(ASSET_PATH + 'GenSekiGothic2TW-M.otf'); // Adjust filename as needed
        clickSound = loadSound(ASSET_PATH + 'click-234708.mp3');
        crashSound = loadSound(ASSET_PATH + 'crash-7075.mp3');
        bonusSound = loadSound(ASSET_PATH + 'game-bonus-2-294436.mp3');
        gameOverSound = loadSound(ASSET_PATH + 'game-over-2-sound-effect-230463.mp3');
        gameStartSound = loadSound(ASSET_PATH + 'game-start-6104.mp3');
        laserSound = loadSound(ASSET_PATH + 'warning-sound-6686.mp3');
        spaceImg = loadImage(ASSET_PATH + 'IMG_2975.PNG');
        starshipImg = loadImage(ASSET_PATH + 'IMG_2930.PNG');
        starshipInDangerImg = loadImage(ASSET_PATH + 'IMG_2976.PNG');
        spaceObject1Img = loadImage(ASSET_PATH + 'IMG_2983.PNG');
        spaceObject2Img = loadImage(ASSET_PATH + 'IMG_2982.PNG');
        spaceObject3Img = loadImage(ASSET_PATH + 'IMG_2978.PNG');
        spaceObject4Img = loadImage(ASSET_PATH + 'IMG_2979.PNG');
        spaceObject5Img = loadImage(ASSET_PATH + 'IMG_2980.PNG');
        spaceObject6Img = loadImage(ASSET_PATH + 'IMG_2981.PNG');
        spaceObject7Img = loadImage(ASSET_PATH + 'IMG_2986.PNG');
        spaceObject8Img = loadImage(ASSET_PATH + 'IMG_2988.PNG');
        spaceObject9Img = loadImage(ASSET_PATH + 'IMG_2989.PNG');
        spaceObject10Img = loadImage(ASSET_PATH + 'IMG_2990.PNG');
        scoreImg = loadImage(ASSET_PATH + 'IMG_2941.PNG');
        livesImg = loadImage(ASSET_PATH + 'IMG_2936.PNG');
        bonusImg = loadImage(ASSET_PATH + 'IMG_2941.PNG');
        explosionImg = loadImage(ASSET_PATH + 'IMG_2932.PNG');

        loadTable(ASSET_PATH + 'kautian_詞目_20250116_hanji_poj_poj.csv', 'csv', 'header',
            (table) => {
                taigiWords = [];
                for (let r = 0; r < table.getRowCount(); r++) {
                    let hanji = table.getString(r, '漢字');
                    let poj = table.getString(r, '羅馬字');
                    if (hanji && poj && hanji.length <= 5) {
                        taigiWords.push({ hanji, poj });
                    }
                }
                console.log("Loaded Taigi words:", taigiWords.length);
            },
            () => {
                taigiWords = [
    {
        poj: "tsi̍t-kuá-á tsînn",
        hanji: "一寡仔錢"
    },
    {
        poj: "tsi̍t-kuá mi̍h-kiānn",
        hanji: "一寡物件"
    },
    {
        poj: "tsi̍t-tiunn phue-sìn",
        hanji: "一張批信"
    },
    {
        poj: "tsi̍t kue̍h kam-tsià",
        hanji: "一橛甘蔗"
    },
    {
        poj: "tsi̍t tsâng muî-kuì",
        hanji: "一欉玫瑰"
    },
    {
        poj: "tsi̍t pha tiān-hué",
        hanji: "一葩電火"
    },
    {
        poj: "tsi̍t tíng bō-á",
        hanji: "一頂帽仔"
    },
    {
        poj: "sann-tsa̍p-thóng huè",
        hanji: "三十捅歲"
    },
    {
        poj: "siōng-khò tok-ku",
        hanji: "上課啄龜"
    },
    {
        poj: "siōng-khò tuh-ku",
        hanji: "上課盹龜"
    },
    {
        poj: "ē-hâi tsiam-tsiam",
        hanji: "下頦尖尖"
    },
    {
        poj: "hōo lâng o-ló",
        hanji: "予人呵咾"
    },
    {
        poj: "hōo guá bî tio̍h",
        hanji: "予我眯著"
    },
    {
        poj: "Lîn-sing hái-hái",
        hanji: "人生海海"
    },
    {
        poj: "I teh hām-bîn",
        hanji: "伊咧陷眠"
    },
    {
        poj: "i ê hîng-iánn",
        hanji: "伊的形影"
    },
    {
        poj: "I tsin sit-tsì",
        hanji: "伊真失志"
    },
    {
        poj: "I tsin tsa̍p-liām",
        hanji: "伊真雜唸"
    },
    {
        poj: "tī thôo-kha liàn",
        hanji: "佇塗跤輾"
    },
    {
        poj: "Lí kám-beh khì",
        hanji: "你敢欲去"
    },
    {
        poj: "Lí tsin bân-phuê",
        hanji: "你真蠻皮"
    },
    {
        poj: "kah lâng puânn-nuá",
        hanji: "佮人盤撋"
    },
    {
        poj: "kah i leh kiânn",
        hanji: "佮伊咧行"
    },
    {
        poj: "kò-sìng huē-ha̍p",
        hanji: "個性會合"
    },
    {
        poj: "kò-sìng im-thim",
        hanji: "個性陰鴆"
    },
    {
        poj: "sông koh ū-la̍t",
        hanji: "倯閣有力"
    },
    {
        poj: "guā-tsē sóo-huì",
        hanji: "偌濟所費"
    },
    {
        poj: "tsò-hué lâi-khì",
        hanji: "做伙來去"
    },
    {
        poj: "Kè-siàu tsin kuân",
        hanji: "價數真懸"
    },
    {
        poj: "nn̄g pha phû-tô",
        hanji: "兩葩葡萄"
    },
    {
        poj: "nn̄g-luí ba̍k-tsiu",
        hanji: "兩蕊目睭"
    },
    {
        poj: "kā lâng tshiàng-siann",
        hanji: "共人唱聲"
    },
    {
        poj: "kā lâng koo-tsiânn",
        hanji: "共人姑情"
    },
    {
        poj: "liōng tsa̍p hun-tsing",
        hanji: "冗十分鐘"
    },
    {
        poj: "uan-ke sio-phah",
        hanji: "冤家相拍"
    },
    {
        poj: "Tshut-kok tshit-thô",
        hanji: "出國𨑨迌"
    },
    {
        poj: "thiau-kang kóng ê",
        hanji: "刁工講的"
    },
    {
        poj: "kiu-kha-kiu-tshiú",
        hanji: "勼跤勼手"
    },
    {
        poj: "Kóo-tsui gín-á",
        hanji: "古錐囡仔"
    },
    {
        poj: "o-ló ha̍k-sing",
        hanji: "呵咾學生"
    },
    {
        poj: "lán tsa-bóo-kiánn",
        hanji: "咱查某囝"
    },
    {
        poj: "siánn-mih tāi-tsì",
        hanji: "啥物代誌"
    },
    {
        poj: "tshuì-tûn ta-ta",
        hanji: "喙脣焦焦"
    },
    {
        poj: "nâ-âu huat-iām",
        hanji: "嚨喉發炎"
    },
    {
        poj: "Thôo-kha lap-sap",
        hanji: "塗跤垃圾"
    },
    {
        poj: "tuā-tsâng tshiū-á",
        hanji: "大欉樹仔"
    },
    {
        poj: "Thinn-khì tsin hip",
        hanji: "天氣真翕"
    },
    {
        poj: "Thinn-sik oo-àm",
        hanji: "天色烏暗"
    },
    {
        poj: "Koo-put-jî-tsiong",
        hanji: "姑不而將"
    },
    {
        poj: "ka-tîng sàn-tshiah",
        hanji: "家庭散赤"
    },
    {
        poj: "Ke-si-thâu-á",
        hanji: "家私頭仔"
    },
    {
        poj: "sió-khuá sing-lí",
        hanji: "小可生理"
    },
    {
        poj: "sió bî tsi̍t-ē",
        hanji: "小眯一下"
    },
    {
        poj: "sió tsat tsi̍t-ē",
        hanji: "小節一下"
    },
    {
        poj: "hāng-á tsin e̍h",
        hanji: "巷仔真狹"
    },
    {
        poj: "kan-na sann ê",
        hanji: "干焦三个"
    },
    {
        poj: "Iù-siù gín-á",
        hanji: "幼秀囡仔"
    },
    {
        poj: "Kuí-nā pah-bān",
        hanji: "幾若百萬"
    },
    {
        poj: "uan-uan-uat-uat",
        hanji: "彎彎斡斡"
    },
    {
        poj: "uan-uan-khiau-khiau",
        hanji: "彎彎曲曲"
    },
    {
        poj: "He sī guá ê",
        hanji: "彼是我的"
    },
    {
        poj: "āu-ji̍t kuè-nî",
        hanji: "後日過年"
    },
    {
        poj: "āu-ji̍t hîng Lí",
        hanji: "後日還你"
    },
    {
        poj: "bî-bî-á-tshiò",
        hanji: "微微仔笑"
    },
    {
        poj: "sim-lāi ngiau-ngiau",
        hanji: "心內擽擽"
    },
    {
        poj: "sim-lāi kan-khóo",
        hanji: "心內艱苦"
    },
    {
        poj: "sim-kuann-á-kiánn",
        hanji: "心肝仔囝"
    },
    {
        poj: "sim-kuann tsiok gîng",
        hanji: "心肝足凝"
    },
    {
        poj: "uàn-thàn gue̍h mî",
        hanji: "怨嘆月暝"
    },
    {
        poj: "khong-khong gōng-gōng",
        hanji: "悾悾戇戇"
    },
    {
        poj: "lú-lâi-lú tsē",
        hanji: "愈來愈濟"
    },
    {
        poj: "guá tsham lí khì",
        hanji: "我參你去"
    },
    {
        poj: "tú-tio̍h kuì-lîn",
        hanji: "拄著貴人"
    },
    {
        poj: "phah ka-lún-sún",
        hanji: "拍交懍恂"
    },
    {
        poj: "án-ne-mah hó",
        hanji: "按呢嘛好"
    },
    {
        poj: "án-ne tō tio̍h",
        hanji: "按呢就著"
    },
    {
        poj: "e-e-tīn-tīn",
        hanji: "挨挨陣陣"
    },
    {
        poj: "nge̍h tī tiong-ng",
        hanji: "挾佇中央"
    },
    {
        poj: "lia̍h Bué-ia̍h-á",
        hanji: "掠尾蝶仔"
    },
    {
        poj: "tshi̍h hōo i tiâu",
        hanji: "揤予伊牢"
    },
    {
        poj: "tshiau âng-mn̂g-thôo",
        hanji: "搜紅毛塗"
    },
    {
        poj: "tn̄g-tio̍h tông-o̍h",
        hanji: "搪著同學"
    },
    {
        poj: "tsham tsi̍t-kuá thn̂g",
        hanji: "摻一寡糖"
    },
    {
        poj: "lu lâi lu khì",
        hanji: "攄來攄去"
    },
    {
        poj: "sàn-tsia̍h gín-á",
        hanji: "散食囡仔"
    },
    {
        poj: "ji̍t-sî siōng-pan",
        hanji: "日時上班"
    },
    {
        poj: "ji̍t-sî tsoh-sit",
        hanji: "日時作穡"
    },
    {
        poj: "kíng-tì tsin suí",
        hanji: "景緻真媠"
    },
    {
        poj: "tì-sik hūn-tsú",
        hanji: "智識份子"
    },
    {
        poj: "ū-kàu iàn-khì",
        hanji: "有夠厭氣"
    },
    {
        poj: "ū-kàu thó-tsè",
        hanji: "有夠討債"
    },
    {
        poj: "ū-kàu huì-khì",
        hanji: "有夠費氣"
    },
    {
        poj: "ū-kàu ut-tsut",
        hanji: "有夠鬱卒"
    },
    {
        poj: "iú-hàu sī-tuā",
        hanji: "有孝序大"
    },
    {
        poj: "iú-hàu pē-bú",
        hanji: "有孝爸母"
    },
    {
        poj: "tsa-poo-gín-á",
        hanji: "查埔囡仔"
    },
    {
        poj: "tsa-bóo-gín-á",
        hanji: "查某囡仔"
    },
    {
        poj: "toh-tíng ni kam",
        hanji: "桌頂拈柑"
    },
    {
        poj: "him-siān pa̍t-lâng",
        hanji: "欣羨別人"
    },
    {
        poj: "beh khì tó-uī",
        hanji: "欲去佗位"
    },
    {
        poj: "M̄-nā án-ne",
        hanji: "毋但按呢"
    },
    {
        poj: "m̄-bián uàn-thàn",
        hanji: "毋免怨嘆"
    },
    {
        poj: "m̄-thang tshìn-tshái",
        hanji: "毋通凊彩"
    },
    {
        poj: "m̄-thang sit-tsì",
        hanji: "毋通失志"
    },
    {
        poj: "m̄-thang pua̍h-kiáu",
        hanji: "毋通跋筊"
    },
    {
        poj: "khì-sin-lóo-miā",
        hanji: "氣身惱命"
    },
    {
        poj: "Kiû sîn pó-pì",
        hanji: "求神保庇"
    },
    {
        poj: "ta̍uh-ta̍uh-á kóng",
        hanji: "沓沓仔講"
    },
    {
        poj: "ua̍h-beh thiám-sí",
        hanji: "活欲忝死"
    },
    {
        poj: "Hái-íng tsin tuā",
        hanji: "海湧真大"
    },
    {
        poj: "Tshing-bîng puē-bōng",
        hanji: "清明培墓"
    },
    {
        poj: "Káng-too iā ú",
        hanji: "港都夜雨"
    },
    {
        poj: "Phuann ài huê-siu",
        hanji: "潘愛回收"
    },
    {
        poj: "bô khînn bô khi̍p",
        hanji: "無拑無扱"
    },
    {
        poj: "bô-mê-bô-ji̍t",
        hanji: "無暝無日"
    },
    {
        poj: "tsiàu-khí-kang lâi",
        hanji: "照起工來"
    },
    {
        poj: "tsiàu-khí-kang tsò",
        hanji: "照起工做"
    },
    {
        poj: "pē-bú sinn-tsiânn",
        hanji: "爸母生成"
    },
    {
        poj: "Mi̍h-kiānn tìn-uī",
        hanji: "物件鎮位"
    },
    {
        poj: "iu-guân m̄-tsai",
        hanji: "猶原毋知"
    },
    {
        poj: "hiàn-tshut guân-hîng",
        hanji: "現出原形"
    },
    {
        poj: "hiān tsú hiān tsia̍h",
        hanji: "現煮現食"
    },
    {
        poj: "suān-tsio̍h tshiú-tsí",
        hanji: "璇石手指"
    },
    {
        poj: "huî-á kang-tiûnn",
        hanji: "瓷仔工場"
    },
    {
        poj: "tong-sî khui-huē",
        hanji: "當時開會"
    },
    {
        poj: "puânn-suann-kuè-niá",
        hanji: "盤山過嶺"
    },
    {
        poj: "ba̍k-tsiu peh-kim",
        hanji: "目睭擘金"
    },
    {
        poj: "ba̍k-tsiu tîng-sûn",
        hanji: "目睭重巡"
    },
    {
        poj: "tsin-hó ka-tsài",
        hanji: "真好佳哉"
    },
    {
        poj: "Tshuah han-tsî-tshiam",
        hanji: "礤番薯簽"
    },
    {
        poj: "siā-huē oo-àm",
        hanji: "社會烏暗"
    },
    {
        poj: "Tik-á lâng-sn̂g",
        hanji: "竹仔籠床"
    },
    {
        poj: "thn̂g-kam-bi̍t-tinn",
        hanji: "糖甘蜜甜"
    },
    {
        poj: "Soh-á līng khì",
        hanji: "索仔冗去"
    },
    {
        poj: "tuè lâng sî-kiânn",
        hanji: "綴人時行"
    },
    {
        poj: "tuè-bē-tio̍h tīn",
        hanji: "綴袂著陣"
    },
    {
        poj: "iân-tâu gín-á",
        hanji: "緣投囡仔"
    },
    {
        poj: "lāu-huè-á-lâng",
        hanji: "老歲仔人"
    },
    {
        poj: "lāu-huè-á-ba̍k",
        hanji: "老歲仔目"
    },
    {
        poj: "khó-tiâu tāi-ha̍k",
        hanji: "考牢大學"
    },
    {
        poj: "tsīnn tsíng-thâu-á",
        hanji: "舐指頭仔"
    },
    {
        poj: "tsīnn ki-á-ping",
        hanji: "舐枝仔冰"
    },
    {
        poj: "Hue tsin tshing-phang",
        hanji: "花真清芳"
    },
    {
        poj: "Mài koh liū ah",
        hanji: "莫閣餾矣"
    },
    {
        poj: "ô-á-mī-suànn",
        hanji: "蚵仔麵線"
    },
    {
        poj: "Buē-tàng kè-sio̍k",
        hanji: "袂當繼續"
    },
    {
        poj: "bē-tsia̍h-bē-khùn",
        hanji: "袂食袂睏"
    },
    {
        poj: "khòo-thâu siunn līng",
        hanji: "褲頭傷冗"
    },
    {
        poj: "Kui-ke-hué-á",
        hanji: "規家伙仔"
    },
    {
        poj: "kui-nî-thàng-thinn",
        hanji: "規年迵天"
    },
    {
        poj: "tshin-tsiânn-gōo-tsa̍p",
        hanji: "親情五十"
    },
    {
        poj: "tshin-tsiânn-pîng-iú",
        hanji: "親情朋友"
    },
    {
        poj: "thó-tsè gín-á",
        hanji: "討債囡仔"
    },
    {
        poj: "Jīn-tsin tsoh-sit",
        hanji: "認真作穡"
    },
    {
        poj: "kóng sim-sng ê",
        hanji: "講心酸的"
    },
    {
        poj: "Kóng-uē sau-siann",
        hanji: "講話梢聲"
    },
    {
        poj: "huì-khì-huì-tak",
        hanji: "費氣費觸"
    },
    {
        poj: "tiô-kha-tǹg-tê",
        hanji: "趒跤頓蹄"
    },
    {
        poj: "tsiok pháinn-liú-la̍k",
        hanji: "足歹扭搦"
    },
    {
        poj: "kha-kut ngiú tio̍h",
        hanji: "跤骨扭著"
    },
    {
        poj: "se̍h înn-khoo-á",
        hanji: "踅圓箍仔"
    },
    {
        poj: "tsàm hōo i tn̄g",
        hanji: "蹔予伊斷"
    },
    {
        poj: "sin-khu tsuân sian",
        hanji: "身軀全鉎"
    },
    {
        poj: "sin-khu ióng-tsòng",
        hanji: "身軀勇壯"
    },
    {
        poj: "Tshia lòng-tio̍h lâng",
        hanji: "車挵著人"
    },
    {
        poj: "Lián-á teh tńg",
        hanji: "輪仔咧轉"
    },
    {
        poj: "tsit-má kuí tiám",
        hanji: "這馬幾點"
    },
    {
        poj: "Tsia ê Hōo lí",
        hanji: "遮的予你"
    },
    {
        poj: "hiong-tshin sī-tuā",
        hanji: "鄉親序大"
    },
    {
        poj: "iân-pit khok-á",
        hanji: "鉛筆觳仔"
    },
    {
        poj: "mn̂g kuainn bô bā",
        hanji: "門關無峇"
    },
    {
        poj: "koh teh bîn-bāng",
        hanji: "閣咧眠夢"
    },
    {
        poj: "hiông-hiông siūnn-bô",
        hanji: "雄雄想無"
    },
    {
        poj: "ke-á thóng bí",
        hanji: "雞仔捅米"
    },
    {
        poj: "Luî-kong sih-nah",
        hanji: "雷公爍爁"
    },
    {
        poj: "sap-sap-á-hōo",
        hanji: "霎霎仔雨"
    },
    {
        poj: "tǹg-í-tǹg-toh",
        hanji: "頓椅頓桌"
    },
    {
        poj: "thâu-mn̂g-giap-á",
        hanji: "頭毛鋏仔"
    },
    {
        poj: "Tsia̍h kah tsiok pá",
        hanji: "食甲足飽"
    },
    {
        poj: "tshī hue-bî ah",
        hanji: "飼花眉仔"
    },
    {
        poj: "but-á-hî muê",
        hanji: "魩仔魚糜"
    },
    {
        poj: "tsiáu-á tshńg mn̂g",
        hanji: "鳥仔吮毛"
    },
    {
        poj: "Tsiáu-á teh háu",
        hanji: "鳥仔咧吼"
    },
    {
        poj: "niáu-tshú-á-uan",
        hanji: "鳥鼠仔冤"
    },
    {
        poj: "n̂g-ki-á-hue",
        hanji: "黃梔仔花"
    }
                ];
                console.log("Using sample Taigi words:", taigiWords);
            }
        );
    }

    function setup() {
        createCanvas(windowWidth, windowHeight);
        textFont(gameFont); // Set the new font as the default
        starship = new Starship();
        targetY = height / 2;
        effects = [];
        resetGame();
        userStartAudio();
        
        // Add event listeners to prevent unwanted position updates
        nextButton.addEventListener('mousedown', () => ignoreMouseMove = true);
        pauseButton.addEventListener('mousedown', () => ignoreMouseMove = true);
        replayButton.addEventListener('mousedown', () => ignoreMouseMove = true);
        document.addEventListener('mouseup', () => ignoreMouseMove = false);
    }

    function draw() {
        image(spaceImg, 0, 0, width, height);
        if (!gameOver && !isPaused) {
            starship.update();
            starship.show();
            handleSpaceObjects();
        }
        for (let i = effects.length - 1; i >= 0; i--) {
            effects[i].show();
            if (effects[i].isExpired()) {
                effects.splice(i, 1);
            }
        }
        displayScoreAndLives();
        if (gameOver) {
            replayButton.style.display = 'block';
            nextButton.style.display = 'none';
            pauseButton.style.display = 'none';
        } else {
            nextButton.style.display = 'block';
            pauseButton.style.display = 'block';
        }
    }

    function changeWord() {
        starship.assignHanji(); // Only change word, preserve position
    }

    function resetGame() {
        score = 0;
        lives = 5;
        spaceObjects = [];
        effects = [];
        bgSpeed = 0.5;
        starship.y = targetY; // Preserve current position instead of resetting to height/2
        starship.assignHanji();
        gameOver = false;
        isPaused = false;
        objectSpawnCount = 0;
        replayButton.style.display = 'none';
        nextButton.style.display = 'block';
        pauseButton.style.display = 'block';
        if (gameStartSound.isLoaded()) {
            gameStartSound.play();
        }
    }

    function togglePause() {
        isPaused = !isPaused;
        pauseButton.innerText = isPaused ? '繼 續' : '歇 睏';
    }

    class Starship {
        constructor() {
            this.x = 80;
            this.y = height / 2;
            this.assignHanji();
        }
        assignHanji() {
            let word = taigiWords[floor(random(taigiWords.length))];
            this.hanji = word.hanji;
            this.matchingPoj = word.poj;
            if (clickSound.isLoaded()) {
                clickSound.play();
            }
        }
        update() {
            this.y = lerp(this.y, targetY, 0.1);
            this.y = constrain(this.y, 20, height - 20);
        }
        show() {
            push();
            translate(this.x, this.y);
            rotate(HALF_PI);
            imageMode(CENTER);
            let img = (lives > 1) ? starshipImg : starshipInDangerImg;
            image(img, 0, 0, 80, 80);
            pop();
            fill(255);
            textSize(24);
            textAlign(CENTER);
            text(this.hanji, this.x, this.y - 28);
        }
    }

    class SpaceObject {
        constructor() {
            this.x = width;
            this.y = random(height);
            this.speed = bgSpeed + random(1, 3);
            this.color = color(random(100, 255), random(100, 255), random(100, 255));
            
            let rand = random();
            if (rand < 0.1) this.img = spaceObject1Img;
            else if (rand < 0.2) this.img = spaceObject2Img;
            else if (rand < 0.3) this.img = spaceObject3Img;
            else if (rand < 0.4) this.img = spaceObject4Img;
            else if (rand < 0.5) this.img = spaceObject5Img;
            else if (rand < 0.6) this.img = spaceObject6Img;
            else if (rand < 0.7) this.img = spaceObject7Img;
            else if (rand < 0.8) this.img = spaceObject8Img;
            else if (rand < 0.9) this.img = spaceObject9Img;
            else this.img = spaceObject10Img;

            if (random() < 0.3) {
                this.poj = starship.matchingPoj;
            } else {
                this.poj = taigiWords[floor(random(taigiWords.length))].poj;
            }
        }
        
        update() { this.x -= this.speed; }
        
        show() {
            push();
            translate(this.x, this.y);
            imageMode(CENTER);
            image(this.img, 0, 0, 30, 30);
            pop();
            fill(this.color);
            textSize(24);
            textAlign(LEFT);
            text(this.poj, this.x + 30, this.y + 6);
        }
        
        hits(starship) {
            let d = dist(this.x, this.y, starship.x, starship.y);
            return d < 40;
        }
    }

    class Effect {
        constructor(x, y, img, duration) {
            this.x = x; this.y = y; this.img = img;
            this.duration = duration; this.startTime = millis();
        }
        show() {
            if (millis() - this.startTime < this.duration) {
                if (this.img === explosionImg) {
                    image(this.img, this.x, this.y, 65, 65);
                } else {
                    image(this.img, this.x, this.y, 50, 50);
                }
            }
        }
        isExpired() { return millis() - this.startTime >= this.duration; }
    }

    function handleSpaceObjects() {
        if (!isPaused && frameCount % 25 === 0 && !gameOver && taigiWords.length > 0) {
            spaceObjects.push(new SpaceObject());
            objectSpawnCount++;
            if (lives == 1 && objectSpawnCount % WARNING_INTERVAL == 0 && laserSound.isLoaded()) {
                laserSound.play();
            }
        }
        for (let i = spaceObjects.length - 1; i >= 0; i--) {
            if (!isPaused) { spaceObjects[i].update(); }
            spaceObjects[i].show();
            if (!isPaused && spaceObjects[i].hits(starship)) {
                if (spaceObjects[i].poj === starship.matchingPoj) {
                    score += starship.hanji.length * 50;
                    if (bonusSound.isLoaded()) { bonusSound.play(); }
                    effects.push(new Effect(spaceObjects[i].x, spaceObjects[i].y, bonusImg, EFFECT_DURATION));
                    starship.assignHanji();
                } else {
                    lives -= 1;
                    if (lives == 1 && laserSound.isLoaded()) { laserSound.play(); }
                    if (crashSound.isLoaded()) { crashSound.play(); }
                    effects.push(new Effect(spaceObjects[i].x, spaceObjects[i].y, explosionImg, EFFECT_DURATION));
                    if (lives <= 0) {
                        gameOver = true;
                        if (gameOverSound.isLoaded()) { gameOverSound.play(); }
                    }
                }
                spaceObjects.splice(i, 1);
            } else if (spaceObjects[i].x < -100) {
                spaceObjects.splice(i, 1);
            }
        }
    }

    function displayScoreAndLives() {
        const topY = -7;
        fill(0, 0, 50);
        rect(10, topY, 300, 60);
        image(scoreImg, 10, topY + 12, 20, 20);
        fill(255);
        textSize(27);
        text(`着分: ${score}`, 40, topY + 30);
        image(livesImg, 10, topY + 40, 20, 20);
        text(`性命: ${lives}`, 40, topY+ 60);
    }

    function touchMoved() {
        if (!isPaused && touches.length > 0 && !ignoreMouseMove) {
            let overButton = false;
            let buttons = [nextButton, pauseButton];
            if (gameOver) { buttons.push(replayButton); }
            for (let btn of buttons) {
                let rect = btn.getBoundingClientRect();
                let touch = touches[0];
                if (touch.x >= rect.left && touch.x <= rect.right && 
                    touch.y >= rect.top && touch.y <= rect.bottom) {
                    overButton = true;
                    break;
                }
            }
            if (!overButton) { targetY = touches[0].y; }
        }
        return false;
    }

    function mouseMoved() {
        if (!isPaused && !ignoreMouseMove) {
            let overButton = false;
            let buttons = [nextButton, pauseButton];
            if (gameOver) { buttons.push(replayButton); }
            for (let btn of buttons) {
                let rect = btn.getBoundingClientRect();
                if (mouseX >= rect.left && mouseX <= rect.right && 
                    mouseY >= rect.top && mouseY <= rect.bottom) {
                    overButton = true;
                    break;
                }
            }
            if (!overButton) { targetY = mouseY; }
        }
    }

    function mousePressed() {
        if (gameOver) {
            let btn = replayButton;
            let rect = btn.getBoundingClientRect();
            if (mouseX > rect.left && mouseX < rect.right && 
                mouseY > rect.top && mouseY < rect.bottom) {
                resetGame();
            }
        }
    }

    function windowResized() { resizeCanvas(windowWidth, windowHeight); }
</script>
</body>
</html>