<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Game</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
        }

        .screen {
            display: none;
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            margin: 20px 0;
        }

        .screen.active {
            display: block;
        }

        input,
        button {
            padding: 15px 25px;
            margin: 10px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
        }

        button {
            background: #4CAF50;
            color: white;
            cursor: pointer;
            transition: background 0.3s;
        }

        button:hover {
            background: #45a049;
        }

        .option {
            display: block;
            width: 100%;
            margin: 10px 0;
            background: #2196F3;
            text-align: left;
        }

        .option:hover {
            background: #1976D2;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            flex: 1;
            margin: 0 10px;
        }

        .leaderboard {
            text-align: left;
            max-height: 300px;
            overflow-y: auto;
        }

        .player-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
        }

        .skill-card {
            background: gold;
            color: black;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            cursor: pointer;
        }

        .pin-display {
            font-size: 48px;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.2);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        #nextQuestionBtn {
            background: #FF9800 !important;
            color: white !important;
            padding: 15px 25px !important;
            border: none !important;
            border-radius: 8px !important;
            font-size: 16px !important;
            cursor: pointer !important;
            margin-top: 20px !important;
        }

        #nextQuestionBtn:hover {
            background: #F57C00 !important;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- 主選單 -->
        <div id="mainMenu" class="screen active">
            <h1>Quiz Game</h1>
            <button onclick="showJoinScreen()" style="font-size: 24px; padding: 20px 40px; margin: 20px;">加入遊戲</button>
            
            <!-- 主持人按鈕（隱藏在角落） -->
            <button onclick="showHostLogin()" style="position: absolute; top: 10px; right: 10px; font-size: 12px; padding: 5px 10px; background: #666; opacity: 0.3;">主持</button>
        </div>

        <!-- 主持人登入畫面 -->
        <div id="hostLoginScreen" class="screen">
            <h2>主持人登入</h2>
            <input type="password" id="hostPassword" placeholder="請輸入主持人密碼" maxlength="10">
            <button onclick="verifyHostPassword()">登入</button>
            <button onclick="showMainMenu()">返回</button>
            <div id="loginError" style="color: red; margin-top: 10px;"></div>
        </div>

        <!-- 主持人畫面 -->
        <div id="hostScreen" class="screen">
            <h2>主持人控制台</h2>
            <div class="pin-display" id="pinDisplay">PIN: ----</div>
            <button onclick="generatePin()">產生PIN碼</button>
            <button onclick="startGame()" id="startBtn" disabled>開始遊戲</button>
            <button onclick="endGame()" id="endBtn" disabled>結束遊戲</button>
            <div class="stats">
                <div class="stat-item">
                    <h3>遊戲時間</h3>
                    <div id="gameTime">00:00</div>
                </div>
                <div class="stat-item">
                    <h3>參與者數量</h3>
                    <div id="playerCount">0</div>
                </div>
            </div>
            <div class="leaderboard">
                <h3>即時排行榜</h3>
                <div id="hostLeaderboard"></div>
            </div>
            <button onclick="showMainMenu()">返回主選單</button>
        </div>

        <!-- 加入遊戲畫面 -->
        <div id="joinScreen" class="screen">
            <h2>加入遊戲</h2>
            <input type="text" id="pinInput" placeholder="輸入PIN碼" maxlength="4">
            <input type="text" id="nameInput" placeholder="輸入你的名字">
            <button onclick="joinGame()">加入遊戲</button>
            <button onclick="showMainMenu()">返回主選單</button>
        </div>

        <!-- 等待畫面 -->
        <div id="waitingScreen" class="screen">
            <h2>等待遊戲開始...</h2>
            <div id="waitingInfo"></div>
        </div>

        <!-- 遊戲畫面 -->
        <div id="gameScreen" class="screen">
            <div class="stats">
                <div class="stat-item">
                    <h3>分數</h3>
                    <div id="playerScore">0</div>
                </div>
                <div class="stat-item">
                    <h3>排名</h3>
                    <div id="playerRank">-</div>
                </div>
                <div class="stat-item">
                    <h3>連續答對</h3>
                    <div id="streak">0</div>
                </div>
            </div>

            <div id="skillCards"></div>

            <div id="questionContainer">
                <h2 id="questionText"></h2>
                <div id="optionsContainer"></div>
            </div>

            <div id="resultMessage"></div>
            <button id="nextQuestionBtn" onclick="nextQuestion()" style="display: none; margin-top: 20px; background: #FF9800; padding: 15px 25px; border: none; border-radius: 8px; color: white; font-size: 16px; cursor: pointer;">下一題</button>
        </div>

        <!-- 結果畫面 -->
        <div id="resultScreen" class="screen">
            <h2>遊戲結束！</h2>
            <div class="stats">
                <div class="stat-item">
                    <h3>最終分數</h3>
                    <div id="finalScore">0</div>
                </div>
                <div class="stat-item">
                    <h3>最終排名</h3>
                    <div id="finalRank">-</div>
                </div>
            </div>
            <div class="leaderboard">
                <h3>最終排行榜</h3>
                <div id="finalLeaderboard"></div>
            </div>
            <button onclick="showMainMenu()">返回主選單</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
        // Firebase 配置 - 請替換為你的配置
        const firebaseConfig = {
            apiKey: "AIzaSyDBc2hbeevGypp5nbAx14TpzcOSDqPaTEA",
            authDomain: "quiz-game-1b653.firebaseapp.com",
            databaseURL: "https://quiz-game-1b653-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "quiz-game-1b653",
            storageBucket: "quiz-game-1b653.firebasestorage.app",
            messagingSenderId: "173823235565",
            appId: "1:173823235565:web:3c5f57193e64e53cc343e4"
        };

        // 初始化 Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let gameData = {
            questions: [],
            currentPin: null,
            players: {},
            gameStarted: false,
            gameStartTime: null,
            gameTimer: null,
            currentPlayer: null,
            isHost: false
        };

        // 清理過期遊戲房間的函數
        async function cleanupExpiredGames() {
            try {
                const gamesRef = database.ref('games');
                const snapshot = await gamesRef.once('value');
                const existingGames = snapshot.val() || {};
                const now = Date.now();
                let cleanedCount = 0;
                
                for (const [pin, game] of Object.entries(existingGames)) {
                    // 清理超過1小時未活動的遊戲（縮短清理時間）
                    const lastActivity = game.endTime || game.startTime || game.createdTime || 0;
                    if (now - lastActivity > 3600000) { // 1小時
                        await database.ref(`games/${pin}`).remove();
                        cleanedCount++;
                        console.log(`已清理過期遊戲房間: ${pin}`);
                    }
                }
                
                if (cleanedCount > 0) {
                    console.log(`清理完成，共清理 ${cleanedCount} 個過期房間`);
                }
            } catch (error) {
                console.error('清理過期遊戲失敗:', error);
            }
        }

        // 優化資料更新頻率
        let updateThrottle = {};
        function throttledUpdate(playerId, data) {
            const now = Date.now();
            if (!updateThrottle[playerId] || now - updateThrottle[playerId] > 1000) { // 限制每秒最多更新一次
                updateThrottle[playerId] = now;
                return true;
            }
            return false;
        }

        // 載入題目資料
        async function loadQuestions() {
            try {
                console.log('正在載入題目檔案...');
                const response = await fetch('exam.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                gameData.questions = await response.json();
                console.log(`成功載入 ${gameData.questions.length} 道題目`);
                
                // 驗證題目格式
                const validQuestions = gameData.questions.filter(q => 
                    q.Question && q.Answer1 && q.Answer2 && q.Answer3 && q.correct
                );
                if (validQuestions.length !== gameData.questions.length) {
                    console.warn(`發現 ${gameData.questions.length - validQuestions.length} 道格式錯誤的題目`);
                    gameData.questions = validQuestions;
                }
                
            } catch (error) {
                console.error('無法載入題目檔案:', error);
                console.log('使用預設題目');
                gameData.questions = [
                    {
                        "Question": "請問「á」的漢字是啥物？",
                        "Answer1": "仔",
                        "Answer2": "啞", 
                        "Answer3": "鴨",
                        "correct": "仔"
                    },
                    {
                        "Question": "請問「a̍h」的漢字是啥物？",
                        "Answer1": "曷",
                        "Answer2": "盒",
                        "Answer3": "合",
                        "correct": "曷"
                    }
                ];
            }
        }

        // 畫面切換函數
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        function showMainMenu() {
            showScreen('mainMenu');
            resetGame();
        }

        function showHostScreen() {
            showScreen('hostScreen');
        }

        function showJoinScreen() {
            showScreen('joinScreen');
        }

        function showHostLogin() {
            showScreen('hostLoginScreen');
            document.getElementById('hostPassword').value = '';
            document.getElementById('loginError').textContent = '';
        }

        function verifyHostPassword() {
            const password = document.getElementById('hostPassword').value;
            const correctPassword = 'csjhs';
            
            if (password === correctPassword) {
                showScreen('hostScreen');
                document.getElementById('loginError').textContent = '';
            } else {
                document.getElementById('loginError').textContent = '密碼錯誤！';
                document.getElementById('hostPassword').value = '';
            }
        }

        // 主持人功能
        async function generatePin() {
            try {
                // 檢查現有遊戲房間數量
                const gamesRef = database.ref('games');
                const snapshot = await gamesRef.once('value');
                const existingGames = snapshot.val() || {};
                
                // 清理已結束超過1小時的遊戲
                const now = Date.now();
                const gamesToDelete = [];
                
                Object.entries(existingGames).forEach(([pin, game]) => {
                    if (game.ended && game.startTime && (now - game.startTime > 3600000)) { // 1小時
                        gamesToDelete.push(pin);
                    }
                });
                
                // 刪除過期遊戲
                for (const pin of gamesToDelete) {
                    await database.ref(`games/${pin}`).remove();
                    delete existingGames[pin];
                }
                
                // 檢查房間數量限制
                const activeGames = Object.keys(existingGames).length;
                if (activeGames >= 6) {
                    alert('目前遊戲房間已滿（最多6個），請稍後再試！');
                    return;
                }
                
                // 生成新的 PIN 碼，確保不重複
                let newPin;
                do {
                    newPin = Math.floor(1000 + Math.random() * 9000).toString();
                } while (existingGames[newPin]);
                
                gameData.currentPin = newPin;
                gameData.isHost = true;

                // 在 Firebase 建立遊戲房間
                const gameRef = database.ref(`games/${gameData.currentPin}`);
                await gameRef.set({
                    pin: gameData.currentPin,
                    started: false,
                    startTime: null,
                    players: {},
                    host: true,
                    createdTime: Date.now()
                });

                // 監聽玩家加入
                gameRef.child('players').on('value', (snapshot) => {
                    gameData.players = snapshot.val() || {};
                    updatePlayerCount();
                    updateLeaderboard();
                });

                document.getElementById('pinDisplay').textContent = `PIN: ${gameData.currentPin}`;
                document.getElementById('startBtn').disabled = false;
                
                console.log(`遊戲房間已建立，PIN: ${gameData.currentPin}，目前活躍房間數: ${activeGames + 1}/6`);
                
            } catch (error) {
                console.error('建立遊戲房間失敗:', error);
                alert('建立遊戲房間失敗，請重試！');
            }
        }

        function startGame() {
            if (Object.keys(gameData.players).length === 0) {
                alert('沒有參與者！');
                return;
            }

            gameData.gameStarted = true;
            gameData.gameStartTime = Date.now();
            document.getElementById('startBtn').disabled = true;
            document.getElementById('endBtn').disabled = false;

            // 更新 Firebase 遊戲狀態
            const gameRef = database.ref(`games/${gameData.currentPin}`);
            gameRef.update({
                started: true,
                startTime: gameData.gameStartTime
            });

            // 開始計時
            gameData.gameTimer = setInterval(updateGameTime, 1000);
        }

        function endGame() {
            gameData.gameStarted = false;
            document.getElementById('endBtn').disabled = true;
            clearInterval(gameData.gameTimer);

            // 更新 Firebase 遊戲狀態並設定自動清理
            if (gameData.isHost) {
                const gameRef = database.ref(`games/${gameData.currentPin}`);
                gameRef.update({
                    started: false,
                    ended: true,
                    endTime: Date.now()
                });
                
                // 30分鐘後自動清理這個遊戲房間
                setTimeout(async () => {
                    try {
                        await database.ref(`games/${gameData.currentPin}`).remove();
                        console.log(`遊戲房間已自動清理: ${gameData.currentPin}`);
                    } catch (error) {
                        console.error('自動清理失敗:', error);
                    }
                }, 1800000); // 30分鐘
                
                console.log(`遊戲結束，PIN: ${gameData.currentPin}，將在30分鐘後自動清理`);
            }

            if (gameData.currentPlayer) {
                showScreen('resultScreen');
                displayFinalResults();
            }
        }

        function updateGameTime() {
            if (!gameData.gameStartTime) return;

            const elapsed = Math.floor((Date.now() - gameData.gameStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('gameTime').textContent =
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function updatePlayerCount() {
            document.getElementById('playerCount').textContent = Object.keys(gameData.players).length;
        }

        // 參與者功能
        function joinGame() {
            const pin = document.getElementById('pinInput').value;
            const name = document.getElementById('nameInput').value.trim();

            if (!pin || !name) {
                alert('請輸入PIN碼和姓名！');
                return;
            }

            // 檢查遊戲是否存在
            const gameRef = database.ref(`games/${pin}`);
            gameRef.once('value').then((snapshot) => {
                if (!snapshot.exists()) {
                    alert('PIN碼錯誤或遊戲不存在！');
                    return;
                }

                const playerId = Date.now().toString();
                gameData.currentPlayer = playerId;
                gameData.currentPin = pin;

                // 加入遊戲
                const playerRef = gameRef.child(`players/${playerId}`);
                playerRef.set({
                    name: name,
                    score: 0,
                    streak: 0,
                    skillCards: [],
                    joinTime: Date.now()
                });

                // 監聽遊戲狀態
                let hasStartedGame = false;
                gameRef.on('value', (snapshot) => {
                    const gameState = snapshot.val();
                    if (gameState) {
                        console.log('Firebase 狀態更新:', gameState);
                        const wasStarted = gameData.gameStarted;
                        gameData.gameStarted = gameState.started;
                        gameData.players = gameState.players || {};

                        // 只在遊戲剛開始時切換到遊戲畫面並開始第一題
                        if (gameState.started && !gameState.ended && !wasStarted && !hasStartedGame) {
                            console.log('遊戲開始，切換到遊戲畫面');
                            hasStartedGame = true;
                            showScreen('gameScreen');
                            nextQuestion();
                        } else if (gameState.ended) {
                            console.log('遊戲結束');
                            showScreen('resultScreen');
                            displayFinalResults();
                        }

                        // 靜默更新玩家統計，不觸發任何 UI 變化
                        if (gameData.currentPlayer && gameData.players[gameData.currentPlayer]) {
                            const player = gameData.players[gameData.currentPlayer];
                            document.getElementById('playerScore').textContent = player.score || 0;
                            document.getElementById('streak').textContent = player.streak || 0;
                            
                            // 更新排名
                            const sortedPlayers = Object.entries(gameData.players)
                                .sort(([, a], [, b]) => (b.score || 0) - (a.score || 0));
                            const rank = sortedPlayers.findIndex(([id]) => id === gameData.currentPlayer) + 1;
                            document.getElementById('playerRank').textContent = rank;
                        }
                    }
                });

                if (gameData.gameStarted) {
                    hasStartedGame = true;
                    showScreen('gameScreen');
                    nextQuestion();
                } else {
                    showScreen('waitingScreen');
                    document.getElementById('waitingInfo').innerHTML = `
                        <p>玩家: ${name}</p>
                        <p>等待主持人開始遊戲...</p>
                    `;
                }
            }).catch((error) => {
                alert('連接失敗：' + error.message);
            });
        }

        // 遊戲邏輯
        function nextQuestion() {
            console.log('nextQuestion 被呼叫', { 
                currentPlayer: gameData.currentPlayer, 
                gameStarted: gameData.gameStarted,
                questionsLength: gameData.questions.length 
            });

            if (!gameData.currentPlayer || !gameData.gameStarted) {
                console.log('遊戲條件不符，退出 nextQuestion');
                return;
            }

            if (gameData.questions.length === 0) {
                console.error('沒有題目資料');
                return;
            }

            // 清空上一題的結果訊息和隱藏下一題按鈕
            document.getElementById('resultMessage').textContent = '';
            document.getElementById('nextQuestionBtn').style.display = 'none';

            const question = gameData.questions[Math.floor(Math.random() * gameData.questions.length)];
            const correctAnswer = question.correct;
            
            // 創建四個選項（包含正確答案和三個錯誤答案）
            const allOptions = [
                question.Answer1,
                question.Answer2, 
                question.Answer3,
                question.correct
            ];
            
            // 隨機排列選項順序
            shuffleArray(allOptions);

            console.log('題目:', question.Question, '正確答案:', correctAnswer);

            document.getElementById('questionText').textContent = question.Question;

            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';

            allOptions.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'option';
                button.textContent = `${String.fromCharCode(65 + index)}. ${option}`;
                button.onclick = () => checkAnswer(option, correctAnswer);
                optionsContainer.appendChild(button);
            });

            updatePlayerStats();
        }



        function checkAnswer(selectedAnswer, correctAnswer) {
            if (!gameData.currentPlayer || !gameData.players[gameData.currentPlayer]) {
                console.error('玩家資料不存在');
                return;
            }

            const player = gameData.players[gameData.currentPlayer];
            const isCorrect = selectedAnswer === correctAnswer;

            // 禁用所有選項按鈕，防止重複點擊
            const optionButtons = document.querySelectorAll('.option');
            optionButtons.forEach(btn => btn.disabled = true);

            // 計算新的分數和連續答對數
            let newScore = (player.score || 0);
            let newStreak = (player.streak || 0);
            let newSkillCards = player.skillCards || [];

            if (isCorrect) {
                newScore += 1;
                newStreak += 1;
                showResult('答對了！+1分', 'green');

                // 檢查技能卡片
                if (newStreak === 5) {
                    newSkillCards.push({ type: 'steal10', name: '偷取10%' });
                    showResult('獲得技能卡片：偷取10%！', 'gold');
                } else if (newStreak === 10) {
                    // 移除10%卡片，添加50%卡片
                    newSkillCards = newSkillCards.filter(card => card.type !== 'steal10');
                    newSkillCards.push({ type: 'steal50', name: '偷取50%' });
                    showResult('技能卡片升級：偷取50%！', 'gold');
                }
            } else {
                newScore -= 1;
                newStreak = 0;
                showResult('答錯了！-1分', 'red');
            }

            // 更新本地資料
            player.score = newScore;
            player.streak = newStreak;
            player.skillCards = newSkillCards;

            // 優化：只在必要時更新 Firebase
            if (throttledUpdate(gameData.currentPlayer, { score: newScore, streak: newStreak })) {
                const playerRef = database.ref(`games/${gameData.currentPin}/players/${gameData.currentPlayer}`);
                playerRef.update({
                    score: newScore,
                    streak: newStreak,
                    skillCards: newSkillCards
                }).then(() => {
                    console.log('Firebase 更新成功', { score: newScore, streak: newStreak });
                }).catch((error) => {
                    console.error('Firebase 更新失敗:', error);
                });
            }
            
            // 顯示下一題按鈕
            setTimeout(() => {
                const nextBtn = document.getElementById('nextQuestionBtn');
                if (nextBtn) {
                    nextBtn.style.display = 'inline-block';
                    console.log('下一題按鈕已顯示');
                } else {
                    console.error('找不到下一題按鈕');
                }
            }, 100);
        }

        function showResult(message, color) {
            const resultDiv = document.getElementById('resultMessage');
            resultDiv.textContent = message;
            resultDiv.style.color = color;
            resultDiv.style.fontSize = '24px';
            resultDiv.style.fontWeight = 'bold';
        }

        function updatePlayerStats() {
            if (!gameData.currentPlayer || !gameData.players[gameData.currentPlayer]) return;

            const player = gameData.players[gameData.currentPlayer];
            document.getElementById('playerScore').textContent = player.score || 0;
            document.getElementById('streak').textContent = player.streak || 0;

            // 更新排名
            const sortedPlayers = Object.entries(gameData.players)
                .sort(([, a], [, b]) => (b.score || 0) - (a.score || 0));
            const rank = sortedPlayers.findIndex(([id]) => id === gameData.currentPlayer) + 1;
            document.getElementById('playerRank').textContent = rank;

            // 更新技能卡片
            updateSkillCards();
        }

        function updateSkillCards() {
            if (!gameData.currentPlayer || !gameData.players[gameData.currentPlayer]) return;

            const player = gameData.players[gameData.currentPlayer];
            const skillCardsDiv = document.getElementById('skillCards');
            skillCardsDiv.innerHTML = '';

            if (player.skillCards && player.skillCards.length > 0) {
                // 找出分數最高的對手
                const otherPlayers = Object.entries(gameData.players)
                    .filter(([id]) => id !== gameData.currentPlayer)
                    .sort(([, a], [, b]) => (b.score || 0) - (a.score || 0));
                
                const targetInfo = otherPlayers.length > 0 ? 
                    `目標：${otherPlayers[0][1].name}（${otherPlayers[0][1].score || 0}分）` : 
                    '無目標';

                player.skillCards.forEach((card, index) => {
                    const cardDiv = document.createElement('div');
                    cardDiv.className = 'skill-card';
                    
                    // 計算可偷取的分數
                    const stealPercentage = card.type === 'steal50' ? 0.5 : 0.1;
                    const potentialSteal = otherPlayers.length > 0 ? 
                        Math.floor((otherPlayers[0][1].score || 0) * stealPercentage) : 0;
                    
                    cardDiv.innerHTML = `
                        <div style="font-weight: bold;">${card.name}</div>
                        <div style="font-size: 12px; margin-top: 5px;">${targetInfo}</div>
                        <div style="font-size: 12px;">可偷取：${potentialSteal}分</div>
                    `;
                    cardDiv.onclick = () => useSkillCard(index);
                    skillCardsDiv.appendChild(cardDiv);
                });
            }
        }

        function useSkillCard(cardIndex) {
            const player = gameData.players[gameData.currentPlayer];
            const card = player.skillCards[cardIndex];

            // 找到分數最高的其他玩家
            const otherPlayers = Object.entries(gameData.players)
                .filter(([id]) => id !== gameData.currentPlayer)
                .sort(([, a], [, b]) => (b.score || 0) - (a.score || 0));

            if (otherPlayers.length === 0) {
                alert('沒有其他玩家可以偷取分數！');
                return;
            }

            const [targetPlayerId, targetPlayer] = otherPlayers[0];
            const stealPercentage = card.type === 'steal50' ? 0.5 : 0.1;
            const stolenPoints = Math.floor((targetPlayer.score || 0) * stealPercentage);

            // 確認偷取操作
            const confirmMessage = `確定要對「${targetPlayer.name}」（${targetPlayer.score}分）使用「${card.name}」嗎？\n將偷取 ${stolenPoints} 分！`;
            if (!confirm(confirmMessage)) {
                return;
            }

            // 更新分數
            targetPlayer.score = (targetPlayer.score || 0) - stolenPoints;
            player.score = (player.score || 0) + stolenPoints;

            // 移除使用過的卡片
            player.skillCards.splice(cardIndex, 1);

            // 更新 Firebase 中的兩個玩家資料
            const gameRef = database.ref(`games/${gameData.currentPin}/players`);
            gameRef.child(gameData.currentPlayer).update({
                score: player.score,
                skillCards: player.skillCards
            });
            gameRef.child(targetPlayerId).update({
                score: targetPlayer.score
            });

            showResult(`成功從「${targetPlayer.name}」偷取了 ${stolenPoints} 分！`, 'purple');
            updatePlayerStats();
            
            console.log(`技能卡片使用：${player.name || '玩家'} 對 ${targetPlayer.name} 使用 ${card.name}，偷取 ${stolenPoints} 分`);
        }

        function updateLeaderboard() {
            const sortedPlayers = Object.entries(gameData.players)
                .sort(([, a], [, b]) => b.score - a.score);

            const leaderboardDiv = document.getElementById('hostLeaderboard');
            leaderboardDiv.innerHTML = '';

            sortedPlayers.forEach(([id, player], index) => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'player-item';
                playerDiv.innerHTML = `
                    <span>${index + 1}. ${player.name}</span>
                    <span>${player.score}分</span>
                `;
                leaderboardDiv.appendChild(playerDiv);
            });
        }

        function displayFinalResults() {
            const player = gameData.players[gameData.currentPlayer];
            document.getElementById('finalScore').textContent = player.score;

            const sortedPlayers = Object.entries(gameData.players)
                .sort(([, a], [, b]) => b.score - a.score);
            const rank = sortedPlayers.findIndex(([id]) => id === gameData.currentPlayer) + 1;
            document.getElementById('finalRank').textContent = rank;

            const finalLeaderboardDiv = document.getElementById('finalLeaderboard');
            finalLeaderboardDiv.innerHTML = '';

            sortedPlayers.forEach(([id, player], index) => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'player-item';
                playerDiv.innerHTML = `
                    <span>${index + 1}. ${player.name}</span>
                    <span>${player.score}分</span>
                `;
                finalLeaderboardDiv.appendChild(playerDiv);
            });
        }

        function resetGame() {
            // 清理 Firebase 監聽器
            if (gameData.currentPin) {
                database.ref(`games/${gameData.currentPin}`).off();
            }

            gameData.gameStarted = false;
            gameData.currentPin = null;
            gameData.players = {};
            gameData.currentPlayer = null;
            gameData.gameStartTime = null;
            gameData.isHost = false;

            if (gameData.gameTimer) {
                clearInterval(gameData.gameTimer);
                gameData.gameTimer = null;
            }

            document.getElementById('pinDisplay').textContent = 'PIN: ----';
            document.getElementById('startBtn').disabled = true;
            document.getElementById('endBtn').disabled = true;
            document.getElementById('gameTime').textContent = '00:00';
            document.getElementById('playerCount').textContent = '0';
            document.getElementById('pinInput').value = '';
            document.getElementById('nameInput').value = '';
            document.getElementById('nextQuestionBtn').style.display = 'none';
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // 使用量統計
        let sessionStats = {
            dataTransferred: 0,
            gamesCreated: 0,
            playersJoined: 0
        };

        function logDataUsage(operation, bytes) {
            sessionStats.dataTransferred += bytes;
            console.log(`資料使用: ${operation} - ${bytes} bytes，本次總計: ${sessionStats.dataTransferred} bytes`);
        }

        // 初始化
        window.onload = function () {
            loadQuestions();
            
            // 定期清理過期遊戲（每15分鐘，更頻繁清理）
            setInterval(cleanupExpiredGames, 900000);
            
            // 頁面載入時清理一次
            cleanupExpiredGames();
            
            // 每10分鐘顯示使用量統計
            setInterval(() => {
                console.log('本次使用統計:', sessionStats);
            }, 600000);
        };
    </script>
</body>

</html>